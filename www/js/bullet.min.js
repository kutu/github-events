(function($){$.extend({bullet:function(url){var CONNECTING=0;var OPEN=1;var CLOSING=2;var CLOSED=3;var transports={websocket:function(){var ret=false;if(window.WebSocket)ret=window.WebSocket;if(window.MozWebSocket&&navigator.userAgent.indexOf("Firefox/6.0")==-1)ret=window.MozWebSocket;if(ret)return{"heart":true,"transport":ret};return false},xhrPolling:function(){var timeout;var xhr;var fake={readyState:CONNECTING,send:function(data){if(this.readyState!=CONNECTING&&this.readyState!=OPEN)return false;
var fakeurl=url.replace("ws:","http:").replace("wss:","https:");$.ajax({async:false,cache:false,type:"POST",url:fakeurl,data:data,dataType:"text",contentType:"application/x-www-form-urlencoded; charset=utf-8",headers:{"X-Socket-Transport":"xhrPolling"},success:function(data){if(data.length!=0)fake.onmessage({"data":data})}});return true},close:function(){this.readyState=CLOSED;xhr.abort();clearTimeout(timeout);fake.onclose()},onopen:function(){},onmessage:function(){},onerror:function(){},onclose:function(){}};
function poll(){var fakeurl=url.replace("ws:","http:").replace("wss:","https:");xhr=$.ajax({type:"GET",cache:false,url:fakeurl,dataType:"text",data:{},headers:{"X-Socket-Transport":"xhrPolling"},success:function(data){if(fake.readyState==CONNECTING){fake.readyState=OPEN;fake.onopen(fake)}if(data.length!=0)fake.onmessage({"data":data});if(fake.readyState==OPEN)nextPoll()},error:function(xhr){fake.onerror()}})}function nextPoll(){timeout=setTimeout(function(){poll()},100)}nextPoll();return{"heart":false,
"transport":function(){return fake}}}};var tn=0;function next(){var c=0;for(var f in transports){if(tn==c){var t=transports[f]();if(t){var ret=new t.transport(url);ret.heart=t.heart;return ret}tn++}c++}return false}var stream=new function(){var readyState=CLOSED;var heartbeat;var delay=delayDefault=80;var delayMax=1E4;var transport;function init(){readyState=CONNECTING;transport=next();if(!transport){delay=delayDefault;tn=0;stream.ondisconnect();setTimeout(function(){init()},delayMax);return false}transport.onopen=
function(){delay=delayDefault;if(transport.heart)heartbeat=setInterval(function(){stream.onheartbeat()},2E4);if(readyState!=OPEN){readyState=OPEN;stream.onopen()}};transport.onclose=function(){clearInterval(heartbeat);if(readyState==CLOSING){readyState=CLOSED;stream.onclose()}else{if(readyState==CONNECTING)tn++;delay*=2;if(delay>delayMax)delay=delayMax;setTimeout(function(){init()},delay)}};transport.onerror=transport.onclose;transport.onmessage=function(e){stream.onmessage(e)}}init();this.onopen=
function(){};this.onmessage=function(){};this.ondisconnect=function(){};this.onclose=function(){};this.onheartbeat=function(){};this.setURL=function(newURL){url=newURL};this.send=function(data){return transport.send(data)};this.close=function(){readyState=CLOSING;transport.close()}};return stream}})})(jQuery);
